import { FeishuService, CategoryItem, LogData } from '../common/FeishuService';
import { NotificationHelper } from '../common/NotificationHelper';
import { common } from '@kit.AbilityKit';
import notificationManager from '@ohos.notificationManager';
import { promptAction } from '@kit.ArkUI';
import { GuardianService } from '../common/GuardianService';
import { FileLogger } from '../common/FileLogger'; // âœ… å¼•å…¥æ—¥å¿—

enum AppState {
  SELECT_L1 = 0,    // é¦–é¡µ
  ADD_L1 = 1,       // æ·»åŠ åˆ†ç±»
  SELECT_L2 = 2,    // äºŒçº§é€‰æ‹©
  CONFIRM_START = 3,// ç¡®è®¤å¼€å§‹
  SET_TIME = 4,     // è®¾ç½®æ—¶é—´
  TIMER_RUNNING = 5,// è®¡æ—¶ä¸­
  FINISH_INPUT = 6  // ç»“æŸå¡«å†™
}

const now = new Date();
const currentMinute = now.getMinutes();
const leftHours = currentMinute === 0 ? 24 - now.getHours() : 23 - now.getHours();
const leftMinutes = currentMinute === 0 ? 0 : 60 - currentMinute;

@Entry
@Component
struct Index {
  private context = getContext(this) as common.UIAbilityContext;

  @State currentState: AppState = AppState.SELECT_L1;
  @State allCategories: CategoryItem[] = [];
  @State isSubmitting: boolean = false;

  @State selectedL1: string = '';
  @State selectedL2: string = '';
  @State customL2: string = '';
  @State newL1Input: string = '';
  @State taskNote: string = '';

  @State estimatedTime: string = '25';
  
  // âœ… ä½¿ç”¨ StorageProp ç›‘å¬ Service æ•°æ®
  @StorageProp('GS_SecondsRemaining') @Watch('onTimeChange') secondsRemaining: number = 0;
  @StorageProp('GS_TotalSeconds') totalSeconds: number = 0;
  @StorageProp('GS_IsPaused') isPaused: boolean = false;
  // æ­¤å¤„ç›‘å¬ Service æ˜¯å¦åœ¨è¿è¡Œï¼Œè¾…åŠ©åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ç»“æŸ
  // ä½†æˆ‘ä»¬ä¸»è¦é  secondsRemaining å½’é›¶æ¥è§¦å‘ç»“æŸå¼¹çª—
  @StorageProp('GS_IsRunning') isServiceRunning: boolean = false;

  // ç®€åŒ–çš„å®é™…æ—¶é•¿ç»Ÿè®¡ (ä¸å†ç²¾ç¡®åˆ°ç§’ï¼Œç”¨ total - remaining ä¼°ç®—)
  startTime: number = 0;

  async aboutToAppear() {
    this.allCategories = await FeishuService.getCategories();
    try {
      await notificationManager.requestEnableNotification();
      await notificationManager.addSlot(notificationManager.SlotType.SOCIAL_COMMUNICATION);
    } catch (err) {
      console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥', JSON.stringify(err));
    }
  }

  // ç›‘å¬æ—¶é—´å˜åŒ–ï¼Œç”¨äºå¤„ç†å½’é›¶é€»è¾‘
  onTimeChange() {
    // åªæœ‰åœ¨è®¡æ—¶é¡µé¢ï¼Œä¸”æ—¶é—´å½’é›¶ï¼Œä¸” Service å·²ç»åœæ­¢(è¯´æ˜ä¸æ˜¯åˆšåˆå§‹åŒ–)æ—¶ï¼Œæ‰è§¦å‘ç»“æŸ
    if (this.currentState === AppState.TIMER_RUNNING && this.secondsRemaining <= 0 && !this.isServiceRunning) {
        // åªæœ‰å½“æ€»æ—¶é—´ > 0 æ—¶æ‰è®¤ä¸ºæ˜¯æ­£å¸¸çš„ä»»åŠ¡ç»“æŸï¼ˆé˜²æ­¢åˆå§‹åŒ–æ—¶çš„0è§¦å‘ï¼‰
        if (this.totalSeconds > 0) {
            this.showEndConfirmDialog();
        }
    }
  }

  onPageShow() {
    // æ¯æ¬¡åˆ‡å›å‰å°ï¼Œæ£€æŸ¥ä¸€ä¸‹çŠ¶æ€
    // å¦‚æœ Service æ­£åœ¨è¿è¡Œï¼Œå¼ºåˆ¶è·³åˆ°è®¡æ—¶é¡µ
    if (this.isServiceRunning && this.currentState !== AppState.TIMER_RUNNING) {
       this.currentState = AppState.TIMER_RUNNING;
    }
  }

  onBackPress() {
    // ğŸ›¡ï¸ å¼ºåŠ›æ‹¦æˆªï¼šåªè¦åå°æœåŠ¡åœ¨è·‘ï¼Œç»å¯¹ä¸å…è®¸è¿”å›é”®é€€å‡ºï¼
    // ä¸å†ä¾èµ–å¯èƒ½å»¶è¿Ÿçš„ StorageProp æˆ–æœ¬åœ° State
    if (GuardianService.getInstance().isTimerRunning()) {
        // å¯ä»¥ç»™ä¸ªæç¤º
        // promptAction.showToast({ message: 'è®¡æ—¶è¿›è¡Œä¸­ï¼Œæ­£åœ¨åå°è¿è¡Œ' });
        return false; // äº¤ç»™ç³»ç»Ÿå¤„ç†ï¼ˆé€€åå°ï¼‰
    }

    if (this.currentState === AppState.SELECT_L1) return false;
    // if (this.currentState === AppState.TIMER_RUNNING) return false; // è¿™ä¸€è¡Œå…¶å®è¢«ä¸Šé¢çš„è¦†ç›–äº†ï¼Œä½†ä¿ç•™ä¹Ÿæ— å¦¨
    this.handleBack();
    return true;
  }

  handleBack() {
    switch (this.currentState) {
      case AppState.ADD_L1:
        this.currentState = AppState.SELECT_L1; break;
      case AppState.SELECT_L2:
        this.currentState = AppState.SELECT_L1; break;
      case AppState.CONFIRM_START:
        this.currentState = AppState.SELECT_L2; break;
      case AppState.SET_TIME:
        this.currentState = AppState.CONFIRM_START; break;
      case AppState.FINISH_INPUT:
        this.resetApp(); break;
    }
  }

  // --- UI Builders ---
  
  @Builder ViewTitleBar(title: string) {
    Row() {
      Button() {
        Text('â†').fontSize(24).fontWeight(FontWeight.Bold).fontColor('#445460')
      }
      .type(ButtonType.Circle).backgroundColor(Color.Transparent).width(40).height(40)
      .onClick(() => this.handleBack())

      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
        // .padding({ right: 40 }) // âŒ ç§»é™¤è¿™ä¸ª paddingï¼Œå› ä¸ºå³è¾¹è¦æœ‰æŒ‰é’®äº†
        .fontColor('#445460')

      // âœ… æ–°å¢ï¼šæ—¥å¿—è°ƒè¯•æŒ‰é’®
      Button('ğŸ')
        .type(ButtonType.Circle)
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
           this.showLogDialog();
        })
    }
    .width('100%').height(50).alignItems(VerticalAlign.Center).backgroundColor('#BCD7F2').borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder ViewSelectL1() {
    Column({ space: 20 }) {
      Text(`âŒ›ï¸æŠ“ä½ä»Šå¤©å‰©ä¸‹çš„${leftHours}å°æ—¶${leftMinutes}åˆ†é’Ÿï¼æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ`)
        .fontSize(20).fontWeight(FontWeight.Bold).textAlign(TextAlign.Center).lineHeight(30).margin({ top: 20 }).fontColor('#445460')

      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.getUniqueL1(), (item: string) => {
            Button(item).width('80%').height(45).backgroundColor('#677C95')
              .onClick(() => { this.selectedL1 = item; this.currentState = AppState.SELECT_L2; })
              .gesture(LongPressGesture({ repeat: false }).onAction(() => this.handleDeleteCategory(item)))
          })
          Button('+ æ·»åŠ ').width('80%').height(45).backgroundColor('#9AB7D3')
            .onClick(() => { this.currentState = AppState.ADD_L1; })
        }
        .width('100%').alignItems(HorizontalAlign.Center).padding({ bottom: 20 })
      }.layoutWeight(1).width('100%').align(Alignment.Top)
    }.width('100%').height('100%')
  }

  @Builder ViewAddL1() {
    Column() {
      this.ViewTitleBar('æ·»åŠ æ–°åˆ†ç±»')
      Column({ space: 20 }) {
        Text('è¾“å…¥æ–°çš„åˆ†ç±»åç§°').fontSize(18)
        TextInput({ placeholder: 'ä¾‹å¦‚ï¼šå¥èº«' }).onChange((val) => this.newL1Input = val).width('90%')
        Button('ç¡®è®¤').backgroundColor('#677C95').onClick(async () => {
          if (this.newL1Input) {
            let newItem: CategoryItem = { id: 'temp', level1: this.newL1Input, level2: 'é»˜è®¤' };
            this.allCategories.push(newItem);
            FeishuService.addCategory(this.newL1Input);
            this.newL1Input = '';
            this.currentState = AppState.SELECT_L1;
          }
        })
      }.layoutWeight(1).justifyContent(FlexAlign.Center).width('100%')
    }.height('100%')
  }

  @Builder ViewSelectL2() {
    Column() {
      this.ViewTitleBar(this.selectedL1)
      Column({ space: 20 }) {
        Text(`è¯·é€‰æ‹© "${this.selectedL1}"ä¸‹çš„æ—¥ç¨‹æ˜ç»†`).fontSize(20).fontColor('#445460')
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
          ForEach(this.getL2ByL1(this.selectedL1), (item: string) => {
            Button(item).margin(8).height(40).backgroundColor('#677C95')
              .onClick(() => { this.selectedL2 = item; this.currentState = AppState.CONFIRM_START; })
              .gesture(LongPressGesture({ repeat: false }).onAction(() => this.handleDeleteLevel2(item)))
          })
        }
        TextInput({ placeholder: 'è¾“å…¥æ–°çš„æ—¥ç¨‹æ˜ç»†' }).width('90%').backgroundColor('#BCD7F2').placeholderColor('#9AB7D3')
          .onChange((val) => this.customL2 = val).margin({ top: 10 })
        Button('ç¡®è®¤').backgroundColor('#677C95').onClick(async () => {
          if (this.customL2) {
            let newItem: CategoryItem = { id: 'temp', level1: this.selectedL1, level2: this.customL2 };
            this.allCategories.push(newItem);
            FeishuService.addLevel2(this.selectedL1, this.customL2);
            this.selectedL2 = this.customL2;
            this.currentState = AppState.CONFIRM_START;
          } else {
            promptAction.showToast({ message: 'è¯·è¾“å…¥å†…å®¹' });
          }
        }).margin({ top: 10 })
      }.layoutWeight(1).justifyContent(FlexAlign.Center).width('100%')
    }.height('100%')
  }

  @Builder ViewConfirmStart() {
    Column() {
      this.ViewTitleBar('ç¡®è®¤ä»»åŠ¡')
      Column({ space: 30 }) {
        Column({ space: 10 }) {
          Text('ğŸ“šå‡†å¤‡å¼€å§‹ï¼š').fontSize(20).fontWeight(FontWeight.Bold)
          Text(`${this.selectedL1} - ${this.selectedL2}`).fontSize(20)
        }
        Row({ space: 40 }) {
          Button('å›é¦–é¡µ').backgroundColor('#445460').onClick(() => {
             // âœ… è¿™é‡Œæ˜¯ç”¨æˆ·ä¸»åŠ¨æ”¾å¼ƒï¼Œå¿…é¡»åœæ­¢è®¡æ—¶ï¼ˆè™½ç„¶æ­¤æ—¶è¿˜æ²¡å¼€å§‹ï¼Œä½†ä¸ºäº†ä¿é™©ï¼‰
             GuardianService.getInstance().stopTimer(false);
             this.resetApp();
          })
          Button('æ˜¯').backgroundColor('#677C95').onClick(() => { this.currentState = AppState.SET_TIME; })
        }
      }.layoutWeight(1).justifyContent(FlexAlign.Center).width('100%')
    }.height('100%')
  }

  @Builder ViewSetTime() {
    Column() {
      this.ViewTitleBar('è®¾å®šæ—¶é•¿')
      Column({ space: 20 }) {
        Text('â°ï¸é¢„è®¡èŠ±è´¹å¤šå°‘åˆ†é’Ÿï¼Ÿ').fontSize(20)
        TextInput({ text: this.estimatedTime }).type(InputType.Number).width('50%').textAlign(TextAlign.Center)
          .onChange((val) => this.estimatedTime = val)

        Button('å¼€å§‹è®¡æ—¶').backgroundColor('#677C95').onClick(() => {
          const mins = parseInt(this.estimatedTime) || 25;
          this.startTime = new Date().getTime();
          // âœ… å¯åŠ¨ Service è®¡æ—¶
          GuardianService.getInstance().startTimer(mins * 60);
          this.currentState = AppState.TIMER_RUNNING;
        })
      }.layoutWeight(1).justifyContent(FlexAlign.Center).width('100%')
    }.height('100%')
  }

  @Builder ViewTimerRunning() {
    Column({ space: 30 }) {
      Text(`ğŸ‘‰æ­£åœ¨è¿›è¡Œï¼š${this.selectedL2}`).fontSize(18).fontColor('#445460')
      // secondsRemaining ç”± StorageProp è‡ªåŠ¨æ›´æ–°
      Text(this.formatTime(this.secondsRemaining))
        .fontSize(50).fontWeight(FontWeight.Bold)
        .fontColor(this.secondsRemaining <= 0 ? '#FF0000' : '#445460')

      Row({ space: 20 }) {
        Button(this.isPaused ? 'ç»§ç»­' : 'æš‚åœ').backgroundColor('#9AB7D3')
          .onClick(() => {
            if (this.isPaused) {
              // ç»§ç»­ (ä¸ä¼ å‚æ•°)
              GuardianService.getInstance().startTimer();
            } else {
              // æš‚åœ
              GuardianService.getInstance().pauseTimer();
            }
          })

        Button('ç»ˆæ­¢').backgroundColor('#445460')
          .onClick(() => {
            this.showEndConfirmDialog(
              'ç»ˆæ­¢ç¡®è®¤',
              'ç¡®å®šè¦æå‰ç»“æŸå½“å‰ä»»åŠ¡å—ï¼Ÿ',
              'ç¡®è®¤ç»“æŸ',
              'å–æ¶ˆ',
              () => {
                GuardianService.getInstance().stopTimer(false);
                this.currentState = AppState.FINISH_INPUT;
              },
              () => {} // å–æ¶ˆåˆ™æ— æ“ä½œ
            );
          })
      }
    }.width('100%').height('100%').justifyContent(FlexAlign.Center)
  }

  @Builder ViewFinishInput() {
    Column({ space: 20 }) {
      Text('âœ… ä»»åŠ¡å®Œæˆ').fontSize(24)
      TextArea({ placeholder: 'å®Œæˆäº†å“ªäº›å†…å®¹ï¼Ÿ' }).width('90%').height(120).onChange((val) => this.taskNote = val)
      Button(this.isSubmitting ? 'æ­£åœ¨ä¿å­˜...' : 'ä¿å­˜å¹¶å®Œæˆ')
        .backgroundColor(this.isSubmitting ? '#CCCCCC' : '#677C95').enabled(!this.isSubmitting)
        .onClick(async () => {
          this.isSubmitting = true;
          try {
            const endTime = new Date().getTime();
            // ä¼°ç®—å®é™…æ—¶é•¿
            let usedSeconds = this.totalSeconds - this.secondsRemaining;
            if (usedSeconds < 0) usedSeconds = this.totalSeconds; // é˜²å¾¡æ€§
            
            // å¦‚æœæ˜¯å› ä¸ºè¶…æ—¶ç»“æŸï¼Œè¿™é‡Œ secondsRemaining å¯èƒ½æ˜¯ 0ï¼Œæ‰€ä»¥ usedSeconds = totalSeconds
            // å¦‚æœæ˜¯åŠ æ—¶äº†ï¼Œé€»è¾‘ä¼šæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼šåªè®°å½•æœ€åä¸€æ¬¡è®¾å®šçš„æ€»æ—¶é•¿
            // å®é™…ä¸Šåº”è¯¥è®© Service è®°å½•ä¸€ä¸ª cumulativeTime
            
            const actualDuration = Math.ceil(usedSeconds / 60);

            let log = new LogData();
            log.level1 = this.selectedL1;
            log.level2 = this.selectedL2;
            log.duration = actualDuration;
            log.startTime = this.startTime;
            log.endTime = endTime;
            log.notes = this.taskNote;

            await FeishuService.saveActivityLog(log);
            promptAction.showToast({ message: 'âœ… ä¿å­˜æˆåŠŸ' });
            this.resetApp();
          } catch (err) {
            promptAction.showToast({ message: 'âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
            console.error('ä¿å­˜é£ä¹¦å¤±è´¥:', JSON.stringify(err));
          } finally {
            this.isSubmitting = false;
          }
        })
    }.width('100%').height('100%').justifyContent(FlexAlign.Center)
  }

  build() {
    Stack() {
      Column().width('100%').height('100%').backgroundColor('#00000000')
        .onClick(() => { if (this.currentState !== AppState.TIMER_RUNNING) this.context.terminateSelf(); })
      Column() {
        if (this.currentState === AppState.SELECT_L1) this.ViewSelectL1()
        else if (this.currentState === AppState.ADD_L1) this.ViewAddL1()
        else if (this.currentState === AppState.SELECT_L2) this.ViewSelectL2()
        else if (this.currentState === AppState.CONFIRM_START) this.ViewConfirmStart()
        else if (this.currentState === AppState.SET_TIME) this.ViewSetTime()
        else if (this.currentState === AppState.TIMER_RUNNING) this.ViewTimerRunning()
        else if (this.currentState === AppState.FINISH_INPUT) this.ViewFinishInput()
      }
      .width('85%').height('60%').backgroundColor(Color.White).borderRadius(24).padding(20)
      .shadow({ radius: 30, color: '#40000000', offsetX: 0, offsetY: 10 }).clip(true).onClick(() => {})
    }.width('100%').height('100%').alignContent(Alignment.Center)
  }

  // --- Helpers ---

  resetApp() {
    this.selectedL1 = ''; this.selectedL2 = ''; this.customL2 = ''; this.taskNote = '';
    // âŒ ç§»é™¤è¿™é‡Œçš„ stopTimerï¼Œé˜²æ­¢è¢«è¯¯è°ƒç”¨ï¼
    // åªæœ‰ç”¨æˆ·æ˜ç¡®ç‚¹å‡»â€œç»ˆæ­¢â€æˆ–â€œå›é¦–é¡µâ€æ—¶ï¼Œæ‰åœ¨é‚£ä¸ªæŒ‰é’®çš„äº‹ä»¶é‡Œè°ƒ stopTimer
    // GuardianService.getInstance().stopTimer(false);
    
    this.startTime = 0;
    this.currentState = AppState.SELECT_L1;
  }

  showEndConfirmDialog(
    title: string = 'ä»»åŠ¡æç¤º',
    message: string = 'æ—¶é—´åˆ°ï¼æ˜¯å¦ç»“æŸä»»åŠ¡ï¼Ÿ',
    confirmText: string = 'ç»“æŸä»»åŠ¡',
    cancelText: string = 'ç»§ç»­',
    onConfirm: () => void = () => {
      NotificationHelper.stopAlarm();
      this.currentState = AppState.FINISH_INPUT;
    },
    onCancel: () => void = () => {
      // é»˜è®¤ç»§ç»­é€»è¾‘ï¼šå¦‚æœæ˜¯æ—¶é—´åˆ°è§¦å‘çš„ï¼Œè¿™é‡Œå¯ä»¥åŠ æ—¶
      const originalMins = parseInt(this.estimatedTime) || 25;
      const additionalSeconds = originalMins * 60;
      GuardianService.getInstance().startTimer(additionalSeconds);
      NotificationHelper.stopAlarm();
    }
  ) {
    AlertDialog.show({
      title: title,
      message: message,
      autoCancel: false,
      primaryButton: {
        value: cancelText,
        action: onCancel
      },
      secondaryButton: {
        value: confirmText,
        action: onConfirm
      }
    })
  }

  showLogDialog() {
    const logs = FileLogger.readLogs();
    AlertDialog.show({
      title: 'è¿è¡Œæ—¥å¿—',
      message: logs.slice(-2000), // åªæ˜¾ç¤ºæœ€å2000ä¸ªå­—ç¬¦ï¼Œé˜²æ­¢å¤ªé•¿
      primaryButton: {
        value: 'å…³é—­',
        action: () => {}
      },
      secondaryButton: {
        value: 'æ¸…ç©ºæ—¥å¿—',
        fontColor: '#FF0000',
        action: () => {
          FileLogger.clearLogs();
          promptAction.showToast({ message: 'æ—¥å¿—å·²æ¸…ç©º' });
        }
      }
    })
  }

  formatTime(seconds: number): string {
    const absSeconds = Math.abs(seconds);
    const m = Math.floor(absSeconds / 60).toString().padStart(2, '0');
    const s = (absSeconds % 60).toString().padStart(2, '0');
    return `${seconds < 0 ? '-' : ''}${m}:${s}`;
  }

  getUniqueL1(): string[] {
    const l1s: string[] = this.allCategories.map((c) => c.level1);
    let uniqueList: string[] = [];
    l1s.forEach(item => { if (!uniqueList.includes(item)) uniqueList.push(item); })
    return uniqueList;
  }

  getL2ByL1(l1: string): string[] {
    return this.allCategories.filter((c) => c.level1 === l1 && c.level2 !== 'é»˜è®¤').map((c) => c.level2);
  }

  async handleDeleteCategory(level1Name: string) { /* ... same as before ... */ }
  async handleDeleteLevel2(level2Name: string) { /* ... same as before ... */ }
}
