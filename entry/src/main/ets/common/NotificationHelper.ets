import notificationManager from '@ohos.notificationManager';
import vibrator from '@ohos.vibrator';
import { common } from '@kit.AbilityKit';
import { wantAgent } from '@kit.AbilityKit';
import { media } from '@kit.MediaKit';
import { audio } from '@kit.AudioKit';
import { BusinessError } from '@kit.BasicServicesKit';

export class NotificationHelper {
  static readonly NOTIFICATION_ID = 1001;
  static player: media.AVPlayer | undefined;
  static silentPlayer: media.AVPlayer | undefined; // âœ… æ–°å¢ï¼šä¸“é—¨ç”¨äºä¿æ´»çš„é™éŸ³æ’­æ”¾å™¨

  // âœ… æ–°å¢ï¼šéœ‡åŠ¨å®šæ—¶å™¨ IDï¼Œç”¨äºå¾ªç¯éœ‡åŠ¨
  static vibrationTimerId: number = -1;

  // âœ… æ–°å¢ï¼šæ¸…ç†æ‰€æœ‰é™æ€èµ„æº
  static async cleanup() {
    try {
      // åœæ­¢æ‰€æœ‰æ’­æ”¾å™¨
      if (NotificationHelper.player) {
        await NotificationHelper.player.stop();
        await NotificationHelper.player.release();
        NotificationHelper.player = undefined;
      }
      
      if (NotificationHelper.silentPlayer) {
        await NotificationHelper.silentPlayer.stop();
        await NotificationHelper.silentPlayer.release();
        NotificationHelper.silentPlayer = undefined;
      }
      
      // æ¸…ç†å®šæ—¶å™¨
      NotificationHelper.stopVibrationLoop();
      
      console.info('NotificationHelper èµ„æºå·²æ¸…ç†');
    } catch (err) {
      console.error('æ¸…ç†NotificationHelperèµ„æºå¤±è´¥:', JSON.stringify(err));
    }
  }

  // 1. åˆå§‹åŒ–é€šçŸ¥æ¸ é“
  static async initNotificationSlot() {
    try {
      const mySlotType = notificationManager.SlotType.SERVICE_INFORMATION;
      await notificationManager.addSlot(mySlotType);
      console.info('é€šçŸ¥æ¸ é“åˆå§‹åŒ–æˆåŠŸ');
    } catch (err) {
      const error = err as BusinessError;
      console.error(`åˆ›å»ºé€šçŸ¥æ¸ é“å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  // 2. å‘é€è¿›åº¦é€šçŸ¥
  static async publishProgress(minutes: string, seconds: string, progress: number) {
    let wantAgentInfo: wantAgent.WantAgentInfo = {
      wants: [{ bundleName: "com.example.better", abilityName: "EntryAbility" }],
      operationType: wantAgent.OperationType.START_ABILITY,
      requestCode: 0,
      wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
    };
    let agent = await wantAgent.getWantAgent(wantAgentInfo);

    let notificationRequest: notificationManager.NotificationRequest = {
      id: NotificationHelper.NOTIFICATION_ID,
      content: {
        notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
        normal: {
          title: 'â³ ä»»åŠ¡è¿›è¡Œä¸­',
          text: `å‰©ä½™æ—¶é—´ï¼š${minutes}:${seconds}`,
          additionalText: `è¿›åº¦ ${progress}%`
        }
      },
      isOngoing: true,
      wantAgent: agent
    };

    try {
      await notificationManager.publish(notificationRequest);
    } catch (err) {
      const error = err as BusinessError;
      console.error(`é€šçŸ¥å‘é€å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  // âœ… æ–°å¢ï¼šå¯åŠ¨é™éŸ³ä¿æ´» (åœ¨å¼€å§‹è®¡æ—¶æ—¶è°ƒç”¨)
  static async startSilentKeepAlive(context: common.Context) {
    try {
      if (NotificationHelper.silentPlayer) {
        await NotificationHelper.silentPlayer.reset();
      } else {
        NotificationHelper.silentPlayer = await media.createAVPlayer();
      }

      NotificationHelper.silentPlayer.on('stateChange', async (state) => {
        if (state === 'initialized') {
          NotificationHelper.silentPlayer!.audioRendererInfo = {
            usage: audio.StreamUsage.STREAM_USAGE_MUSIC, // å¿…é¡»æ˜¯ MUSIC
            rendererFlags: 0
          };
          await NotificationHelper.silentPlayer!.prepare();
        } else if (state === 'prepared') {
          NotificationHelper.silentPlayer!.loop = true; // å¾ªç¯æ’­æ”¾

          // âœ… å…³é”®ç­–ç•¥ï¼šä¸è¦è®¾ä¸º 0ï¼Œè®¾ä¸ºæå°å€¼ (0.01) é˜²æ­¢è¢«ç³»ç»Ÿæ£€æµ‹ä¸ºæ— æ•ˆæ’­æ”¾
          NotificationHelper.silentPlayer!.setVolume(0.01);

          await NotificationHelper.silentPlayer!.play();
        }
      });

      // è¯»å–ç™½å™ªéŸ³æ–‡ä»¶
      let fileDescriptor = await context.resourceManager.getRawFd('silence.mp3');
      NotificationHelper.silentPlayer.fdSrc = fileDescriptor;

      console.info('âœ… éŸ³é¢‘é©±åŠ¨ä¿æ´»å·²å¯åŠ¨');

    } catch (err) {
      console.error(`é™éŸ³ä¿æ´»å¯åŠ¨å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }

  // âœ… æ–°å¢ï¼šåœæ­¢é™éŸ³ä¿æ´» (åœ¨è®¡æ—¶ç»“æŸæˆ–æš‚åœæ—¶è°ƒç”¨)
  static async stopSilentKeepAlive() {
    if (NotificationHelper.silentPlayer) {
      try {
        await NotificationHelper.silentPlayer.stop();
        await NotificationHelper.silentPlayer.release();
        NotificationHelper.silentPlayer = undefined;
        console.info('ğŸ›‘ é™éŸ³ä¿æ´»å·²åœæ­¢');
      } catch (err) {
        console.error(`åœæ­¢é™éŸ³å¤±è´¥: ${JSON.stringify(err)}`);
      }
    }
  }

  // 3. å‘é€ç»“æŸé€šçŸ¥
  static async publishFinishNotification() {
    let wantAgentInfo: wantAgent.WantAgentInfo = {
      wants: [{ bundleName: "com.example.better", abilityName: "EntryAbility" }],
      operationType: wantAgent.OperationType.START_ABILITY,
      requestCode: 0,
      wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
    };
    let agent = await wantAgent.getWantAgent(wantAgentInfo);
    let notificationRequest: notificationManager.NotificationRequest = {
      id: NotificationHelper.NOTIFICATION_ID,
      content: {
        notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
        normal: {
          title: 'âœ… ä»»åŠ¡å·²ç»“æŸ',
          text: 'æ—¶é—´åˆ°ï¼è¯·ç‚¹å‡»ç¡®è®¤ç»“æŸä»»åŠ¡ã€‚',
          additionalText: 'å·²å®Œæˆ'
        }
      },
      isOngoing: false,
      wantAgent: agent,
      notificationSlotType: notificationManager.SlotType.SERVICE_INFORMATION
    };
    try {
      await notificationManager.publish(notificationRequest);
    } catch (err) {
      const error = err as BusinessError;
      console.error(`å‘é€ç»“æŸé€šçŸ¥å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  // 4. å–æ¶ˆé€šçŸ¥
  static async cancelNotification() {
    try {
      await notificationManager.cancel(NotificationHelper.NOTIFICATION_ID);
    } catch (err) {
      const error = err as BusinessError;
      console.error(`å–æ¶ˆé€šçŸ¥å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  // 5. æ’­æ”¾é—¹é“ƒï¼ˆåŒ…å«åŒæ­¥éœ‡åŠ¨ï¼‰
  static async playAlarm(context: common.Context) {
    try {
      // 1. æ¸…ç†æ—§çŠ¶æ€
      if (NotificationHelper.player) {
        await NotificationHelper.stopAlarm();
      }

      // 2. åˆ›å»ºæ’­æ”¾å™¨
      NotificationHelper.player = await media.createAVPlayer();

      // 3. ç›‘å¬çŠ¶æ€
      NotificationHelper.player.on('stateChange', async (state, reason) => {
        switch (state) {
          case 'initialized':
            if (NotificationHelper.player) {
              // å¼ºåˆ¶ä½¿ç”¨é—¹é’Ÿé€šé“
              let audioRendererInfo: audio.AudioRendererInfo = {
                usage: audio.StreamUsage.STREAM_USAGE_ALARM,
                rendererFlags: 0
              };
              NotificationHelper.player.audioRendererInfo = audioRendererInfo;
              await NotificationHelper.player.prepare();
            }
            break;
          case 'prepared':
            if (NotificationHelper.player) {
              NotificationHelper.player.loop = true; // éŸ³ä¹å¾ªç¯
              await NotificationHelper.player.play(); // éŸ³ä¹å¼€å§‹

              // âœ…âœ…âœ… åŒæ­¥å¼€å§‹éœ‡åŠ¨å¾ªç¯
              NotificationHelper.startVibrationLoop();
            }
            break;
        }
      });

      // 4. è¯»å–èµ„æº
      let fileDescriptor = await context.resourceManager.getRawFd('alarm.mp3');
      NotificationHelper.player.fdSrc = fileDescriptor;
      console.info('âœ… é—¹é“ƒé€»è¾‘å¯åŠ¨');

    } catch (err) {
      const error = err as BusinessError;
      console.error(`æ’­æ”¾éŸ³ä¹å¤±è´¥: ${JSON.stringify(error)}`);
      // å…œåº•ï¼šå¦‚æœéŸ³ä¹æŒ‚äº†ï¼Œè‡³å°‘éœ‡åŠ¨è¿˜è¦å“
      NotificationHelper.startVibrationLoop();
    }
  }

  // 6. åœæ­¢é—¹é“ƒï¼ˆåŒæ—¶åœæ­¢éœ‡åŠ¨ï¼‰
  static async stopAlarm() {
    try {
      // åœæ­¢éŸ³ä¹
      if (NotificationHelper.player) {
        await NotificationHelper.player.stop();
        await NotificationHelper.player.release();
        NotificationHelper.player = undefined;
      }

      // âœ…âœ…âœ… åœæ­¢éœ‡åŠ¨å¾ªç¯
      NotificationHelper.stopVibrationLoop();

      console.info('ğŸ›‘ é—¹é“ƒä¸éœ‡åŠ¨å·²åœæ­¢');
    } catch (err) {
      const error = err as BusinessError;
      console.error(`åœæ­¢å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }

  // âœ…âœ…âœ… æ–°å¢ï¼šå¼€å¯å¾ªç¯éœ‡åŠ¨
  // é€»è¾‘ï¼šæ¯éš” 1.5ç§’ è§¦å‘ä¸€æ¬¡ 1ç§’ çš„éœ‡åŠ¨ï¼Œå½¢æˆ å—¡(1s) - åœ(0.5s) - å—¡(1s) çš„æ•ˆæœ
  static startVibrationLoop() {
    // é˜²æ­¢é‡å¤å¼€å¯
    NotificationHelper.stopVibrationLoop();

    // 1. ç«‹å³è§¦å‘ç¬¬ä¸€æ¬¡
    NotificationHelper.triggerVibration();

    // 2. å¼€å¯å®šæ—¶å™¨å¾ªç¯è§¦å‘
    NotificationHelper.vibrationTimerId = setInterval(() => {
      // æ£€æŸ¥åº”ç”¨æ˜¯å¦ä»ç„¶æ´»è·ƒï¼Œå¦‚æœå®šæ—¶å™¨IDå·²é‡ç½®åˆ™åœæ­¢æ‰§è¡Œ
      if (NotificationHelper.vibrationTimerId === -1) {
        return;
      }
      NotificationHelper.triggerVibration();
    }, 1500); // é—´éš”å»ºè®®æ¯”éœ‡åŠ¨æ—¶é•¿ç¨é•¿ä¸€ç‚¹ï¼Œé˜²æ­¢é‡å 
  }

  // âœ…âœ…âœ… æ–°å¢ï¼šåœæ­¢å¾ªç¯éœ‡åŠ¨
  static stopVibrationLoop() {
    if (NotificationHelper.vibrationTimerId !== -1) {
      clearInterval(NotificationHelper.vibrationTimerId);
      NotificationHelper.vibrationTimerId = -1;
    }
    // å¼ºåˆ¶åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„éœ‡åŠ¨
    try {
      vibrator.stopVibration();
    } catch (err) {
      // å¿½ç•¥é”™è¯¯
    }
  }

  // å•æ¬¡éœ‡åŠ¨é€»è¾‘
  static async triggerVibration() {
    try {
      await vibrator.startVibration({
        type: 'time',
        duration: 1000, // éœ‡åŠ¨ 1000 æ¯«ç§’
      }, {
        id: 0,
        usage: 'alarm' // è®¾ä¸ºé—¹é’Ÿç”¨é€”ï¼Œä¼˜å…ˆçº§é«˜
      });
    } catch (err) {
      const error = err as BusinessError;
      console.error(`éœ‡åŠ¨å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }
}