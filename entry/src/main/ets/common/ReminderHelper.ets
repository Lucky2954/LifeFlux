import { reminderAgentManager } from '@kit.BackgroundTasksKit';
import { notificationManager } from '@kit.NotificationKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { wantAgent } from '@kit.AbilityKit';
import { common } from '@kit.AbilityKit';

// ğŸŸ¢ ä¿®å¤æ–¹æ¡ˆï¼šå®šä¹‰ä¸€ä¸ªä¸´æ—¶æ¥å£æ¥æ›¿ä»£ any
// æ—¢ç„¶ä½ çŸ¥é“ item é‡Œä¸€å®šæœ‰ reminderIdï¼Œå°±æ˜¾å¼åœ°å®šä¹‰å‡ºæ¥
interface ReminderItem {
  reminderId: number;
}

// å®šä¹‰ReminderRequestçš„æ‰©å±•æ¥å£ï¼ŒåŒ…å«reminderIdå±æ€§
interface ReminderRequestWithId {
  reminderId?: number;
}

// å®šä¹‰WantAgentæ¥å£ï¼ŒåŒ…å«å¿…è¦çš„å±æ€§
interface WantAgent {
  pkgName: string;
  abilityName: string;
}

export class ReminderHelper {
  // 1. å‘å¸ƒå€’è®¡æ—¶æé†’
  static async publishTimerReminder(context: common.UIAbilityContext, seconds: number) {
    // ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
    await ReminderHelper.cancelAllReminders();

    if (seconds <= 0) {
      return;
    }

    let wantAgentInfo: wantAgent.WantAgentInfo = {
      wants: [
        {
          bundleName: context.abilityInfo.bundleName,
          abilityName: context.abilityInfo.name
        }
      ],
      operationType: wantAgent.OperationType.START_ABILITY,
      requestCode: 0,
      wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
    };
    try {
      // ğŸŸ¢ ä¿®å¤1ï¼šä½¿ç”¨æ­£ç¡®çš„ç±»å‹å£°æ˜
      let agent = await wantAgent.getWantAgent(wantAgentInfo);

      const timerReq: reminderAgentManager.ReminderRequestTimer = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_TIMER,
        triggerTimeInSeconds: seconds,
        actionButton: [
          {
            title: 'å›åˆ°åº”ç”¨',
            type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE
          }
        ],
        title: 'â³ ä¸“æ³¨ä»»åŠ¡å®Œæˆ',
        content: 'é¢„è®¾æ—¶é—´å·²åˆ°ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…',
        expiredContent: 'æ—¶é—´åˆ°ï¼',
        snoozeTimes: 0,
        ringDuration: 10,
        slotType: notificationManager.SlotType.SOCIAL_COMMUNICATION,
        // ğŸŸ¢ ä¿®å¤ï¼šä½¿ç”¨ç±»å‹æ–­è¨€åŒ¹é…æœŸæœ›çš„ç±»å‹
        wantAgent: agent as WantAgent,
        notificationId: 9999
      };

      const reminderId = await reminderAgentManager.publishReminder(timerReq);
      console.info(`âœ… [ä»£ç†æé†’] å·²æ‰˜ç®¡ç»™ç³»ç»Ÿ, ID: ${reminderId}`);

    } catch (err) {
      const error = err as BusinessError;
      console.error(`âŒ [ä»£ç†æé†’] è®¾ç½®å¤±è´¥: ${error.message}`);
    }
  }

  // 2. å–æ¶ˆå½“å‰åº”ç”¨æ‰€æœ‰çš„ä»£ç†æé†’
  static async cancelAllReminders() {
    try {
      const reminders = await reminderAgentManager.getValidReminders();
      for (let item of reminders) {
        // ğŸŸ¢ ä¿®å¤3ï¼šä½¿ç”¨å®‰å…¨çš„å±æ€§è®¿é—®æ–¹å¼
        let id = (item as ReminderRequestWithId).reminderId;

        if (id) {
          console.info(`ğŸ§¹ æ¸…ç†æ—§æé†’ ID: ${id}`);
          await reminderAgentManager.cancelReminder(id);
        }
      }
    } catch (err) {
      // è¿™é‡Œçš„ err é€šå¸¸æ˜¯ unknownï¼Œè½¬ä¸º string æˆ– BusinessError å¤„ç†
      console.error(`âŒ æ¸…ç†æé†’å¤±è´¥: ${JSON.stringify(err)}`);
    }
  }
}